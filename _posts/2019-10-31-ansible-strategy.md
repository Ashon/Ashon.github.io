---
layout: post
title: "[WIP] Ansible에서 전략 패턴을 이용해 자동화 프로젝트의 확장성을 확보하기"
date: 2019-10-31 00:07:50 +0900
tags:
- devops
- ansible
---

## 개요

`Ansible`은 현재 널리 사용되고 있는 인프라스트럭쳐 자동화 도구다. 많은 서버들을 편리하게 제어할 수 있는 경험을 제공해 준다.

`Ansible`을 사용하다 보면, `Playbook`과 `Task`들 `Role`들을 적절한 단위로 나누어 인프라스트럭쳐 자동화 작업을 하는데,
간혹 자동화의 특정 작업들에 대해 다양성이 필요한 경우가 발생하곤 한다.

이 경우 `Ansible` 에서는 `when` 지시자 같은 조건문 기반으로 태스크들을 쪼개서 관리하는 등의 가이드가 많은데,
이런 방식으로만 코드를 작성해 나가다 보면 조건들이 많아질 경우 태스크들과 조건문들의 참조 관계가 복잡해져 관리가 힘들어지게 되는 문제가 발생한다.

이 경우 적절한 조건이나 값을 이용하여, `Task` 블록들을 독립적인 파일로 만들고 `include_task` 모듈을 통해,
좀 더 깨끗하고 뚜렷한 목적의 `Task` 파일들로 구성하도록 만들어 자동화 프로젝트 코드를 더 깔끔하게 유지하는 방법을 알아본다.

## 전략 패턴?

디자인 패턴과 `OOP`에서 자주 등장하는 단어이고, 서비스 코드를 작성하다 보면 항상 만나는 주제이다.

**어떤 하나의 목적**을 달성하기 위한 **다양한 방식의 행위**들을 **인터페이스**를 맞추고 **캡슐화** 하여,
필요할 때 적절히 교체해서 사용할 수 있게 만들기 위한 디자인 패턴이다.

`Ansible`에서는 `OOP`만큼 지켜야 할 강력한 규칙이나 관계들을 정의하기는 힘들지만,
패턴의 개념을 적절히 `Ansible`의 컴포넌트들로 비추어 전략 패턴으로 큰 로직 흐름은
최소한의 수정으로 유지하면서 풀고자 하는 문제를 해결할 수 있다.

## 예제: 웹 애플리케이션을 배포해 봅시다

어떤 웹 애플리케이션을 배포하는 방식은 여러가지가 있다.
적절히... 시대상(?)을 반영하여 애플리케이션을 배포하는 방식을 전통적인 것 부터 현대적인 방법까지 대략 3단계로 나누어 보았다.

- 베어메탈 서버에 한땀한땀 프로비저닝을 진행하고, 애플리케이션 설정을 한다.
- 요즘같은 시대에 컨테이너를 이용해서, 좀 더 편리하게 애플리케이션을 배포해 보자.
- 오케스트레이터는 기본으로 써야한다. `Kubernetes`도 설치해서 그 위에 애플리케이션을 올리자.

위 세 방식 다 서버를 다루기 위한 공통적인 단계들로 구성되어 있다고 보자. 여기서는 대략 2가지 단계로
나누어 보았다.

1. 인프라스트럭쳐를 셋업하는 부분
1. 애플리케이션을 배포하는 부분

`Ansible`을 이용해서 자동화 한다고 했을 때, 나의 경우는 `Playbook`을 큰 단계로 구분하고,
`Role`, `Task`는 하위 디테일한 작업을 정의하는데 쓴다. 이 경우 대략..

``` sh
$ tree
.
|-- inventory                 # 인벤토리 파일
|
|-- playbooks                 # 서버들을 관리하기 위한 플레이북 모음
|  |-- infrastructure.yml     # 인프라스트럭쳐를 구성한다.
|  \-- deploy.yml             # 애플리케이션을 배포한다.
|
\-- roles                     # 플레이북에 사용되는 롤들을 관리한다.
   |-- infrastructure
   |   \-- tasks
   |       \-- main.yml       # 인프라스트럭쳐 구성 task
   |
   \-- deploy
       \-- tasks
           \-- main.yml       # 배포작업 task
```

같은 형식으로 디렉토리를 구성해서 사용한다.

`playbooks/infrastructure.yml` 플레이북은 `infrastructure` `Role`을 호출하게 되고,
호스트들은 정의 된 `Task` 블록들로, 적절히 애플리케이션 배포를 위한 프로비저닝 작업이 진행된다.

`playbooks/deploy.yml` 플레이북은 적절히 애플리케이션을 배포하고 설정하는 로직을 갖는다.

### 새로운 배포환경으로 점진적으로 변경해 나가기

지금까지 구현 된 `Ansible` 자동화 프로젝트를 이용해서, 새로운 배포환경으로 애플리케이션을 점진적으로
업그레이드 해 나가기로 한다.

이 경우, 애플리케이션 배포 환경에 대한 `infrastructure` `Role`의 `Task`들을 모두 교체하게 된다면,
기존 운영환경의 부득이한 사정으로 새로운 배포환경으로 갈 수 없는 상태의 호스트는 해당 자동화 스크립트를
사용할 수 없게 된다.

그렇다면, 이전 가능한 호스트들만 새로운 롤을 적용해 보는건 어떨까?

이 경우에는 기존 인벤토리에서 이전할 호스트들을 새롭게 `Inventory Group`을 만들고,
해당 그룹을 위한 task들을 따로 할당해 주는 방법이 좋을 것 같다.

#### `Inventory` 나누기

먼저 이전할 호스트들을 선정하고 새로운 `Inventory Group`을 할당한다.

``` conf
# file: inventory

# 변경하기 전의 인벤토리의 webserver 그룹
[webservers]
region-app-[01:30].mysite.com
```

에서

``` conf
# file: inventory

[webservers]
region-app-[01:20].mysite.com

# 21 ~ 30번 까지의 호스트는 새로운 배포환경으로 가기로 하였다.
[webservers_v2]
region-app[21:30].mysite.com
```

#### 새로운 `Inventory Group`을 위한 `Task` 만들기

이제 새로운 호스트를 위한 `Task`를 만들고, `infrastructure` `Playbook`에 추가해 주어야 한다.